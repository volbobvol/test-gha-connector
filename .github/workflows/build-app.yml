name: Build and Sign

on:
  workflow_dispatch:

env:
  ORGANIZATION_ID: fe33c075-e317-4587-9ecc-0495c44c45e0
  SIGNIN_POLICY_SLUG: e2e-test-sp
  PROJECT_SLUG: e2e-gha-test-project
  CONNECTOR_URL: https://x8qqnrvl-44353.euw.devtunnels.ms
  ARTIFACT_CONFIGURATION_SLUG: exe-in-zip

jobs:
  build-and-sign:
    permissions:
      actions: read  # get run data
      contents: read  # do checkout

    runs-on: windows-latest

    steps:

    - name: Run submit signing request
        uses: signpath/github-action-submit-signing-request@main
        with:
            connector-url: ${{ vars.CONNECTOR_URL }}
            api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
            organization-id: ${{ vars.ORGANIZATION_ID }}
            project-slug:  ${{ vars.PROJECT_SLUG }}
            signing-policy-slug:  ${{ vars.SIGNIN_POLICY_SLUG }}
            artifact-configuration-slug: exe-in-zip
            github-artifact-id: '${{ steps.upload-artifact-step.outputs.artifact-id }}'
            output-artifact-directory: signed-artifact

